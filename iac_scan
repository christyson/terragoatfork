# Build a Docker image and scan it for issues using Veracode's Container Scan

trigger:
- none

resources:
- repo: self

stages:
- stage: Build
# https://docs.veracode.com/r/veracode_sbom#target-type shows the different types of targets you can scan (i.e. image, repo, directory etc.)
# https://docs.veracode.com/r/veracode_sbom#flags shows the different formats you can use for container scanning
    - script: |
        curl -fsS https://tools.veracode.com/veracode-cli/install | sh
        export VERACODE_API_KEY_ID=$(VERACODE_ID)
        export VERACODE_API_KEY_SECRET=$(VERACODE_KEY)
        ./veracode scan --type directory --source ${Build.SourcesDirectory} --output veracode_terragoat.json
        export PASSFAIL=$(jq -r '."policy-passed"' veracode_terragoat.json)
        echo $PASSFAIL
        if [ $PASSFAIL == "false" ]; then exit 1; fi
      displayName: 'Download Veracode Container/IaC scan and scan repo'
      env:
        VERACODE_ID: $(VERACODE_ID)
        VERACODE_KEY: $(VERACODE_KEY)
    - publish: $(System.DefaultWorkingDirectory)/veracode_terragoat.json
      artifact: Repo_scan
      displayName: 'Publish the repos scan'
